<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Talk to Ava</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; background: #0a0a0a; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; }

    #tavus-start {
      display: flex; align-items: center; justify-content: center;
      width: 100%; height: 100%; cursor: pointer;
      flex-direction: column; gap: 16px;
    }
    #tavus-start:hover .play-btn { transform: scale(1.08); }

    .play-btn {
      width: 72px; height: 72px; border-radius: 50%; background: #fff197;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.2s ease;
    }

    #tavus-loading {
      display: none; align-items: center; justify-content: center;
      width: 100%; height: 100%; flex-direction: column; gap: 12px;
    }
    .spinner {
      width: 40px; height: 40px; border: 3px solid #333;
      border-top-color: #fff197; border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #tavus-video { display: none; width: 100%; height: 100%; }
    #tavus-video iframe { width: 100%; height: 100%; border: 0; }
  </style>
</head>
<body>

  <div id="tavus-start" onclick="startTavusConversation()">
    <div class="play-btn">
      <svg width="32" height="32" fill="#0a0a0a" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
    </div>
    <span style="color:white;font-size:16px;font-weight:500;">Talk to Ava</span>
    <span style="color:#888;font-size:13px;">Click to start a live video conversation</span>
  </div>

  <div id="tavus-loading">
    <div class="spinner"></div>
    <span style="color:#aaa;font-size:14px;">Connecting to Ava...</span>
  </div>

  <div id="tavus-video"></div>

  <script src="https://unpkg.com/@daily-co/daily-js"></script>
  <script>
    var TAVUS_API_KEY = "d12c850f6bb54a9ebd38739f5493b1ae";
    var PERSONA_ID = "pc4cf52bed59";
    var REPLICA_ID = "r4317e64d25a";

    var TOOL_ENDPOINTS = {
      "get_available_times": "https://ashleyg89.app.n8n.cloud/webhook/calendly-availability",
      "book_demo_meeting":   "https://ashleyg89.app.n8n.cloud/webhook/calendly-book",
      "generate_use_cases":  "https://ashleyg89.app.n8n.cloud/webhook/generate-use-cases"
    };

    var callFrame = null;
    var conversationId = null;

    function startTavusConversation() {
      document.getElementById("tavus-start").style.display = "none";
      document.getElementById("tavus-loading").style.display = "flex";

      fetch("https://tavusapi.com/v2/conversations", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": TAVUS_API_KEY
        },
        body: JSON.stringify({
          persona_id: PERSONA_ID,
          replica_id: REPLICA_ID,
          conversation_name: "Website Visitor ‚Äî " + new Date().toLocaleString(),
          conversational_context: "The visitor just clicked to talk to Ava on aiworkforceacademy.io. They are likely interested in learning about the AI Builder Program.",
          custom_greeting: "Hey there! I'm Ava from AI Workforce Academy. I help people figure out if our AI Builder Program could be a good fit... and I tell the occasional bad joke along the way. What brings you here today?",
          properties: {
            max_call_duration: 600,
            participant_left_timeout: 30,
            participant_absent_timeout: 120
          }
        })
      })
      .then(function(res) {
        if (!res.ok) {
          return res.text().then(function(t) { throw new Error("API " + res.status + ": " + t); });
        }
        return res.json();
      })
      .then(function(data) {
        var meetingUrl = data.conversation_url;
        conversationId = data.conversation_id;

        if (!meetingUrl) {
          throw new Error("No conversation_url: " + JSON.stringify(data));
        }

        console.log("‚úÖ Conversation created:", conversationId);

        document.getElementById("tavus-loading").style.display = "none";
        document.getElementById("tavus-video").style.display = "block";

        callFrame = window.Daily.createFrame(
          document.getElementById("tavus-video"),
          {
            iframeStyle: { width: "100%", height: "100%", border: "0" },
            showLeaveButton: true
          }
        );

        callFrame.on("app-message", function(event) {
          var msg = event.data;
          console.log("üì© app-message:", msg);
          if (msg && msg.event_type === "conversation.tool_call") {
            console.log("üîß Tool call:", msg);
            handleToolCall(msg);
          }
        });

        callFrame.on("left-meeting", function() {
          document.getElementById("tavus-video").style.display = "none";
          document.getElementById("tavus-start").style.display = "flex";
          if (callFrame) { callFrame.destroy(); callFrame = null; }
        });

        return callFrame.join({ url: meetingUrl });
      })
      .then(function() {
        console.log("‚úÖ Joined meeting");
      })
      .catch(function(err) {
        console.error("‚ùå Error:", err);
        document.getElementById("tavus-loading").style.display = "none";
        document.getElementById("tavus-start").style.display = "flex";
        alert("Sorry, couldn't connect. Please try again.");
      });
    }

    function handleToolCall(msg) {
      var toolName = msg.properties ? msg.properties.name : null;
      var rawArgs = msg.properties ? msg.properties.arguments : "{}";
      var parsedArgs = {};
      try { parsedArgs = typeof rawArgs === "string" ? JSON.parse(rawArgs) : (rawArgs || {}); }
      catch(e) { console.warn("‚ö†Ô∏è Bad args:", rawArgs); }

      console.log("üîß Routing: " + toolName, parsedArgs);
      var endpoint = TOOL_ENDPOINTS[toolName];

      if (!endpoint) {
        console.warn("‚ö†Ô∏è Unknown tool: " + toolName);
        sendEcho("I'm sorry, I ran into a technical issue. Could you ask me that a different way?");
        return;
      }

      fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(parsedArgs)
      })
      .then(function(res) {
        var ct = res.headers.get("content-type") || "";
        return ct.indexOf("application/json") !== -1 ? res.json() : res.text();
      })
      .then(function(result) {
        console.log("‚úÖ N8N response for " + toolName + ":", result);
        var text;
        if (typeof result === "string") { text = result; }
        else { text = result.message || result.response || result.text || result.output || (result.data ? (typeof result.data === "string" ? result.data : JSON.stringify(result.data)) : JSON.stringify(result)); }
        sendEcho(text);
      })
      .catch(function(err) {
        console.error("‚ùå Tool error " + toolName + ":", err);
        sendEcho("I had trouble looking that up. Could you try asking me again?");
      });
    }

    function sendEcho(text) {
      if (!callFrame || !conversationId) return;
      callFrame.sendAppMessage({
        message_type: "conversation",
        event_type: "conversation.echo",
        conversation_id: conversationId,
        properties: { modality: "text", text: text }
      }, "*");
      console.log("üì§ Sent echo:", text.substring(0, 100));
    }
  </script>
</body>
</html>
